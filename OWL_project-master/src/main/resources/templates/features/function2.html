<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카페 검색</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        #map {
            height: 100%;
            width: 100%;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #0f172a;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .gm-style-iw {
            background-color: #1e293b !important;
            color: white !important;
        }

        .gm-style-iw-d {
            overflow: hidden !important;
        }

        .gm-style .gm-style-iw-tc::after {
            background: #1e293b !important;
        }

        /* Custom Control Styling - Refined */
        .radius-control-container {
            margin-top: 110px;
            margin-left: 12px;
        }

        .radius-group {
            background-color: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 12px;
            padding: 6px;
            display: inline-flex;
            flex-direction: column;
            /* Vertical */
            gap: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .radius-btn {
            background-color: transparent;
            color: #94a3b8;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            /* Adjusted padding */
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            text-align: center;
        }

        .radius-btn:hover {
            color: #f1f5f9;
            background-color: rgba(51, 65, 85, 0.5);
        }

        .radius-btn.active {
            background-color: #10b981 !important;
            color: white !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: 700;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <!-- Radius Controls (Will be pushed to map) -->
    <div id="radius-controls" class="radius-control-container" style="display:none;">
        <div class="radius-group">
            <button class="radius-btn" onclick="changeRadius(100, this)">100m</button>
            <button class="radius-btn" onclick="changeRadius(300, this)">300m</button>
            <button class="radius-btn" onclick="changeRadius(500, this)">500m</button>
            <button class="radius-btn active" onclick="changeRadius(1000, this)">1km</button>
        </div>
    </div>

    <script>
        let map;
        let infowindow;
        let currentMarkers = [];
        let currentLocation = null;
        let currentRadius = 1000;

        function initMap() {
            // Default location (Seoul)
            const defaultLocation = new google.maps.LatLng(37.534522948, 126.994243914);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        createMap(currentLocation);
                    },
                    () => {
                        currentLocation = defaultLocation;
                        createMap(currentLocation);
                    }
                );
            } else {
                currentLocation = defaultLocation;
                createMap(currentLocation);
            }
        }

        function createMap(location) {
            map = new google.maps.Map(document.getElementById("map"), {
                center: location,
                zoom: 15,
                disableDefaultUI: false,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                    { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
                    { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
                ]
            });

            const controlDiv = document.getElementById("radius-controls");
            controlDiv.style.display = "block";
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(controlDiv);

            searchPlaces(currentRadius);
        }

        function changeRadius(radius, btn) {
            document.querySelectorAll('.radius-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            currentRadius = radius;

            let zoomLevel = 15;
            if (radius <= 100) zoomLevel = 18;
            else if (radius <= 300) zoomLevel = 17;
            else if (radius <= 500) zoomLevel = 16;
            else zoomLevel = 15;

            map.setZoom(zoomLevel);
            map.setCenter(currentLocation);

            searchPlaces(radius);
        }

        function searchPlaces(radius) {
            if (!currentLocation) return;

            currentMarkers.forEach(m => m.setMap(null));
            currentMarkers = [];

            const request = {
                location: currentLocation,
                radius: radius,
                type: "cafe",
                openNow: true
            };

            const service = new google.maps.places.PlacesService(map);
            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    for (let i = 0; i < results.length; i++) {
                        const place = results[i];
                        if (place.business_status && place.business_status !== 'OPERATIONAL') continue;
                        if (place.opening_hours && place.opening_hours.open_now === false) continue;

                        createMarker(place);
                    }
                }
            });
        }

        function createMarker(place) {
            if (!place.geometry || !place.geometry.location) return;

            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                animation: google.maps.Animation.DROP
            });

            google.maps.event.addListener(marker, "click", () => {
                const placeName = place.name;
                const address = place.vicinity || "";

                const request = {
                    placeId: place.place_id,
                    fields: ["opening_hours"]
                };

                const service = new google.maps.places.PlacesService(map);
                service.getDetails(request, (placeResult, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {

                        let isOpen = true;
                        let statusText = "영업중";
                        let statusClass = "bg-emerald-900/50 text-emerald-300 border border-emerald-700/50";

                        if (placeResult.opening_hours) {
                            try {
                                const check = placeResult.opening_hours.isOpen();
                                if (check === false) isOpen = false;
                            } catch (e) {
                                if (placeResult.opening_hours.open_now === false) isOpen = false;
                            }
                        }

                        if (!isOpen) {
                            statusText = "영업종료";
                            statusClass = "bg-rose-900/50 text-rose-300 border border-rose-700/50";
                        }

                        let remainingTimeStr = "";
                        let progressBarWidth = "0%";
                        let progressColor = "bg-slate-600";

                        if (isOpen && placeResult.opening_hours && placeResult.opening_hours.periods) {
                            const today = new Date();
                            const currentDayIndex = today.getDay();
                            const period = placeResult.opening_hours.periods.find(p => p.close && p.close.day === currentDayIndex);

                            if (period) {
                                let closingHour = parseInt(period.close.time.substring(0, 2));
                                const closingMinute = parseInt(period.close.time.substring(2, 4));

                                const closingTime = new Date();
                                closingTime.setHours(closingHour, closingMinute, 0);

                                if (closingTime < today) {
                                    closingTime.setDate(closingTime.getDate() + 1);
                                }

                                const timeDiff = closingTime - today;
                                if (timeDiff > 0) {
                                    const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                                    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                                    remainingTimeStr = `${hours}시간 ${minutes}분`;

                                    if (hours >= 3) {
                                        progressColor = "bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
                                        progressBarWidth = "100%";
                                    } else if (hours >= 1) {
                                        progressColor = "bg-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.5)]";
                                        progressBarWidth = "60%";
                                    } else {
                                        progressColor = "bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.5)]";
                                        progressBarWidth = "20%";
                                    }
                                }
                            }
                        }

                        const contentDiv = document.createElement("div");
                        contentDiv.className = "text-left font-sans bg-slate-800 text-white p-1 min-w-[260px]";
                        const searchPars = encodeURIComponent(placeName + " " + address);
                        const googleSearchUrl = `https://www.google.com/search?q=${searchPars}`;

                        contentDiv.innerHTML = `
                    <div class="mb-3">
                        <div class="flex justify-between items-start gap-2">
                             <h3 class="text-lg font-bold text-white leading-tight break-keep" style="color: #f1f5f9;">${placeName}</h3>
                             <a href="${googleSearchUrl}" target="_blank" class="shrink-0 bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-white p-1.5 rounded-lg transition-colors" title="구글 검색">
                                <i class="fab fa-google text-sm"></i>
                             </a>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">${address}</p>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-4">
                        <span class="px-2.5 py-1 rounded-full text-xs font-bold ${statusClass} inline-flex items-center">
                            <span class="w-1.5 h-1.5 rounded-full ${isOpen ? 'bg-emerald-400' : 'bg-rose-400'} mr-1.5 shadow-sm"></span>
                            ${statusText}
                        </span>
                         <a href="${googleSearchUrl}" target="_blank" class="px-2.5 py-1 rounded-full text-xs font-medium bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500/30 hover:text-indigo-200 transition-colors inline-flex items-center gap-1">
                            <i class="fas fa-search text-[10px]"></i> 상세정보
                        </a>
                    </div>

                    ${remainingTimeStr ? `
                    <div class="bg-slate-700/50 rounded-lg p-2.5 border border-slate-700">
                        <div class="flex justify-between items-end mb-2">
                             <span class="text-[11px] text-slate-400 font-medium">마감까지</span>
                             <span class="text-sm font-bold text-emerald-300 font-mono tracking-wide">${remainingTimeStr}</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                            <div class="${progressColor} h-1.5 rounded-full transition-all duration-500" style="width: ${progressBarWidth}"></div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${!remainingTimeStr && isOpen ? `<p class="text-[11px] text-slate-500 py-2">영업 시간 정보가 제한적입니다.</p>` : ''}
                `;

                        if (infowindow) {
                            infowindow.close();
                        }

                        infowindow = new google.maps.InfoWindow({
                            content: contentDiv,
                            maxWidth: 320
                        });
                        infowindow.open(map, marker);
                    }
                });
            });
        }
    </script>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap&libraries=places&v=weekly"
        defer></script>
</body>

</html>